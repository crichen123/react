{"ast":null,"code":"import\"antd/es/card/style/css\";import _Card from\"antd/es/card\";import\"antd/es/modal/style/css\";import _Modal from\"antd/es/modal\";import\"antd/es/table/style/css\";import _Table from\"antd/es/table\";import\"antd/es/button/style/css\";import _Button from\"antd/es/button\";import _regeneratorRuntime from\"/home/crc/WebstormProjects/react-admin/node_modules/@babel/runtime/regenerator\";import _toConsumableArray from\"/home/crc/WebstormProjects/react-admin/node_modules/@babel/runtime/helpers/esm/toConsumableArray\";import\"antd/es/message/style/css\";import _message from\"antd/es/message\";import _asyncToGenerator from\"/home/crc/WebstormProjects/react-admin/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _classCallCheck from\"/home/crc/WebstormProjects/react-admin/node_modules/@babel/runtime/helpers/esm/classCallCheck\";import _createClass from\"/home/crc/WebstormProjects/react-admin/node_modules/@babel/runtime/helpers/esm/createClass\";import _possibleConstructorReturn from\"/home/crc/WebstormProjects/react-admin/node_modules/@babel/runtime/helpers/esm/possibleConstructorReturn\";import _getPrototypeOf from\"/home/crc/WebstormProjects/react-admin/node_modules/@babel/runtime/helpers/esm/getPrototypeOf\";import _inherits from\"/home/crc/WebstormProjects/react-admin/node_modules/@babel/runtime/helpers/esm/inherits\";import React from'react';import{PAGE_SIZE}from\"../../utils/constant\";import AddForm from\"./add-form\";import AuthForm from\"./auth-form\";import{reqAddUser,reqUpdateRole}from\"../../api\";import memoryUtils from\"../../utils/memoryUtils\";import{formateDate}from\"../../utils/dateUtils\";import storageUtiles from\"../../utils/storageUtiles\";var Role=/*#__PURE__*/function(_React$Component){_inherits(Role,_React$Component);function Role(props){var _this;_classCallCheck(this,Role);_this=_possibleConstructorReturn(this,_getPrototypeOf(Role).call(this,props));_this.state={roles:[{\"menus\":[\"/home\",\"/products\",\"/category\",\"/product\",\"/role\"],\"_id\":\"5ca9eac0\",\"name\":\"角色1\",\"create_time\":1554639552758,\"_v\":0,\"auth_time\":1557630307021,\"auth_name\":\"admim\"}],loading:false,role:{},isShowAdd:false,isShowAuth:false};_this.initColumn=function(){_this.columns=[{title:'角色名称',dataIndex:'name'},{title:'创建时间',dataIndex:'create_time',render:function render(creat_time){return formateDate(creat_time);}},{title:'授权时间',dataIndex:'auth_time',render:formateDate},{title:'授权人',dataIndex:'auth_name'}];};_this.addRole=function(){_this.form.validateFields(/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(err,values){var roleName,result,role;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:if(err){_context.next=8;break;}_this.setState({isShowAdd:false});roleName=values.roleName;_this.form.resetFields();_context.next=6;return reqAddUser(roleName);case 6:result=_context.sent;if(result.status===0){_message.success(\"添加陈宫\");role=result.data;_this.setState(function(state){return{roles:[].concat(_toConsumableArray(state.roles),[role])};});}else{_message.error(\"添加失败\");}case 8:case\"end\":return _context.stop();}}},_callee);}));return function(_x,_x2){return _ref.apply(this,arguments);};}());};_this.updateRole=/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(){var role,menus,result;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_this.setState({isShowAuth:true});role=_this.state.role;menus=_this.auth.current.getMenus;role.menus=menus;role.auth_name=memoryUtils.user.username;role.auth_time=Date.now();_context2.next=8;return reqUpdateRole(role);case 8:result=_context2.sent;if(result.state===0){_message.success(\"设置角色权限成功\");if(role._id==memoryUtils.user.role._id){memoryUtils.user={};storageUtiles.removeUser();_this.props.history.replace('/login');}_this.setState({roles:_toConsumableArray(_this.state.roles)});}else{_message.error(\"设置角色失败\");}case 10:case\"end\":return _context2.stop();}}},_callee2);}));_this.handleCancel=function(){_this.setState({isShowAdd:false});_this.form.resetFields();};_this.handleCancelAuth=function(){_this.setState({isShowAuth:false});};_this.onRow=function(role){return{onClick:function onClick(event){_this.setState({role:role});}};};_this.auth=React.createRef();return _this;}_createClass(Role,[{key:\"componentWillMount\",value:function componentWillMount(){this.initColumn();}// componentWillReceiveProps(nextProps, nextContext) {\n//     console.log(nextProps.role);\n//    // const menus = nextProps.role.menus\n//    // this.state.checkedKeys = menus\n// }\n},{key:\"render\",value:function render(){var _this2=this;var _this$state=this.state,roles=_this$state.roles,loading=_this$state.loading,role=_this$state.role,isShowAdd=_this$state.isShowAdd,isShowAuth=_this$state.isShowAuth;var title=React.createElement(\"span\",null,React.createElement(_Button,{type:\"primary\",onClick:function onClick(){return _this2.setState({isShowAdd:true});}},\"\\u521B\\u5EFA\\u89D2\\u8272\"),\"\\xA0\\xA0\",React.createElement(_Button,{type:\"primary\",disabled:!role._id,onClick:function onClick(){return _this2.setState({isShowAuth:true});}},\"\\u8BBE\\u7F6E\\u89D2\\u8272\\u6743\\u9650\"));var rowSelection={type:'radio',selectedRowKeys:[role._id],onSelect:function onSelect(role){_this2.setState({role:role});}};return React.createElement(_Card,{title:title},React.createElement(_Table,{bordered:true,rowKey:\"_id\",loadding:loading,dataSource:roles,columns:this.columns,pagination:{defaultPageSize:5},rowSelection:rowSelection,onRow:this.onRow}),React.createElement(_Modal,{title:\"\\u6DFB\\u52A0\\u89D2\\u8272\",visible:isShowAdd,onOk:this.addRole,onCancel:this.handleCancel},React.createElement(AddForm,{setForm:function setForm(form){_this2.form=form;}})),React.createElement(_Modal,{title:\"\\u8BBE\\u7F6E\\u6743\\u9650\",visible:isShowAuth,onOk:this.updateRole,onCancel:this.handleCancelAuth},React.createElement(AuthForm,{ref:this.auth,role:role})));}}]);return Role;}(React.Component);export{Role as default};","map":{"version":3,"sources":["/home/crc/WebstormProjects/react-admin/src/pages/role/role.jsx"],"names":["React","PAGE_SIZE","AddForm","AuthForm","reqAddUser","reqUpdateRole","memoryUtils","formateDate","storageUtiles","Role","props","state","roles","loading","role","isShowAdd","isShowAuth","initColumn","columns","title","dataIndex","render","creat_time","addRole","form","validateFields","err","values","setState","roleName","resetFields","result","status","success","data","error","updateRole","menus","auth","current","getMenus","auth_name","user","username","auth_time","Date","now","_id","removeUser","history","replace","handleCancel","handleCancelAuth","onRow","onClick","event","createRef","rowSelection","type","selectedRowKeys","onSelect","defaultPageSize","Component"],"mappings":"2yCAAA,MAAOA,CAAAA,KAAP,KAAkB,OAAlB,CAEA,OAAQC,SAAR,KAAwB,sBAAxB,CACA,MAAOC,CAAAA,OAAP,KAAoB,YAApB,CACA,MAAOC,CAAAA,QAAP,KAAqB,aAArB,CACA,OAAQC,UAAR,CAAmBC,aAAnB,KAAuC,WAAvC,CACA,MAAOC,CAAAA,WAAP,KAAwB,yBAAxB,CACA,OAAQC,WAAR,KAA0B,uBAA1B,CACA,MAAOC,CAAAA,aAAP,KAA0B,2BAA1B,C,GAEqBC,CAAAA,I,0EAuBjB,cAAYC,KAAZ,CAAmB,sCACf,sEAAMA,KAAN,GADe,MAtBnBC,KAsBmB,CAtBX,CACJC,KAAK,CAAC,CAAC,CACH,QAAQ,CACJ,OADI,CAEJ,WAFI,CAGJ,WAHI,CAIJ,UAJI,CAKJ,OALI,CADL,CAQH,MAAM,UARH,CASH,OAAO,KATJ,CAUH,cAAc,aAVX,CAWH,KAAK,CAXF,CAYH,YAAY,aAZT,CAaH,YAAY,OAbT,CAAD,CADF,CAgBJC,OAAO,CAAC,KAhBJ,CAiBJC,IAAI,CAAC,EAjBD,CAkBJC,SAAS,CAAC,KAlBN,CAmBJC,UAAU,CAAC,KAnBP,CAsBW,OAKnBC,UALmB,CAKN,UAAK,CACd,MAAKC,OAAL,CAAe,CACX,CACIC,KAAK,CAAC,MADV,CAEIC,SAAS,CAAC,MAFd,CADW,CAIR,CACCD,KAAK,CAAC,MADP,CAECC,SAAS,CAAC,aAFX,CAGCC,MAAM,CAAC,gBAACC,UAAD,QAAcf,CAAAA,WAAW,CAACe,UAAD,CAAzB,EAHR,CAJQ,CAQT,CACEH,KAAK,CAAC,MADR,CAEEC,SAAS,CAAC,WAFZ,CAGEC,MAAM,CAACd,WAHT,CARS,CAYT,CACEY,KAAK,CAAC,KADR,CAEEC,SAAS,CAAC,WAFZ,CAZS,CAAf,CAiBH,CAvBkB,OAyBnBG,OAzBmB,CAyBV,UAAK,CACV,MAAKC,IAAL,CAAUC,cAAV,0FAAyB,iBAAMC,GAAN,CAAUC,MAAV,8IACjBD,GADiB,yBAEjB,MAAKE,QAAL,CAAc,CAACb,SAAS,CAAC,KAAX,CAAd,EACOc,QAHU,CAGEF,MAHF,CAGVE,QAHU,CAIjB,MAAKL,IAAL,CAAUM,WAAV,GAJiB,sBAKI1B,CAAAA,UAAU,CAACyB,QAAD,CALd,QAKXE,MALW,eAMjB,GAAGA,MAAM,CAACC,MAAP,GAAgB,CAAnB,CAAqB,CACjB,SAAQC,OAAR,CAAgB,MAAhB,EACMnB,IAFW,CAEJiB,MAAM,CAACG,IAFH,CAGjB,MAAKN,QAAL,CAAc,SAAAjB,KAAK,QAAG,CAClBC,KAAK,8BAAKD,KAAK,CAACC,KAAX,GAAiBE,IAAjB,EADa,CAAH,EAAnB,EAIH,CAPD,IAOK,CACD,SAAQqB,KAAR,CAAc,MAAd,EACH,CAfgB,sDAAzB,oEAkBH,CA5CkB,OA8CnBC,UA9CmB,sEA8CN,8JACT,MAAKR,QAAL,CAAc,CACVZ,UAAU,CAAC,IADD,CAAd,EAGMF,IAJG,CAII,MAAKH,KAAL,CAAWG,IAJf,CAKHuB,KALG,CAKK,MAAKC,IAAL,CAAUC,OAAV,CAAkBC,QALvB,CAMT1B,IAAI,CAACuB,KAAL,CAAaA,KAAb,CACAvB,IAAI,CAAC2B,SAAL,CAAiBnC,WAAW,CAACoC,IAAZ,CAAiBC,QAAlC,CACA7B,IAAI,CAAC8B,SAAL,CAAiBC,IAAI,CAACC,GAAL,EAAjB,CARS,uBASYzC,CAAAA,aAAa,CAACS,IAAD,CATzB,QASHiB,MATG,gBAUT,GAAGA,MAAM,CAACpB,KAAP,GAAe,CAAlB,CAAoB,CAChB,SAAQsB,OAAR,CAAgB,UAAhB,EACA,GAAGnB,IAAI,CAACiC,GAAL,EAAYzC,WAAW,CAACoC,IAAZ,CAAiB5B,IAAjB,CAAsBiC,GAArC,CAAyC,CACrCzC,WAAW,CAACoC,IAAZ,CAAkB,EAAlB,CACAlC,aAAa,CAACwC,UAAd,GACA,MAAKtC,KAAL,CAAWuC,OAAX,CAAmBC,OAAnB,CAA2B,QAA3B,EACH,CACD,MAAKtB,QAAL,CAAc,CACVhB,KAAK,oBAAK,MAAKD,KAAL,CAAWC,KAAhB,CADK,CAAd,EAGH,CAVD,IAUK,CACD,SAAQuB,KAAR,CAAc,QAAd,EACH,CAtBQ,yDA9CM,SAwEnBgB,YAxEmB,CAwEL,UAAI,CACd,MAAKvB,QAAL,CAAc,CAACb,SAAS,CAAC,KAAX,CAAd,EACA,MAAKS,IAAL,CAAUM,WAAV,GACH,CA3EkB,OA6EnBsB,gBA7EmB,CA6ED,UAAI,CAClB,MAAKxB,QAAL,CAAc,CAACZ,UAAU,CAAC,KAAZ,CAAd,EAEH,CAhFkB,OAkFnBqC,KAlFmB,CAkFX,SAACvC,IAAD,CAAQ,CACZ,MAAO,CACHwC,OAAO,CAAG,iBAAAC,KAAK,CAAE,CACb,MAAK3B,QAAL,CAAc,CACVd,IAAI,CAAJA,IADU,CAAd,EAGH,CALE,CAAP,CAOH,CA1FkB,CAEf,MAAKwB,IAAL,CAAYtC,KAAK,CAACwD,SAAN,EAAZ,CAFe,aAGlB,C,gFA0FmB,CAChB,KAAKvC,UAAL,GACH,CAED;AACA;AACA;AACA;AACA;uCAGQ,iCAC8C,KAAKN,KADnD,CACGC,KADH,aACGA,KADH,CACSC,OADT,aACSA,OADT,CACiBC,IADjB,aACiBA,IADjB,CACsBC,SADtB,aACsBA,SADtB,CACgCC,UADhC,aACgCA,UADhC,CAGJ,GAAMG,CAAAA,KAAK,CACP,gCACQ,6BAAQ,IAAI,CAAC,SAAb,CAAuB,OAAO,CAAE,yBAAI,CAAA,MAAI,CAACS,QAAL,CAAc,CAACb,SAAS,CAAE,IAAZ,CAAd,CAAJ,EAAhC,6BADR,YAEQ,6BAAQ,IAAI,CAAC,SAAb,CAAuB,QAAQ,CAAE,CAACD,IAAI,CAACiC,GAAvC,CAA4C,OAAO,CAAE,yBAAI,CAAA,MAAI,CAACnB,QAAL,CAAc,CAACZ,UAAU,CAAE,IAAb,CAAd,CAAJ,EAArD,yCAFR,CADJ,CAOA,GAAMyC,CAAAA,YAAY,CAAI,CAClBC,IAAI,CAAC,OADa,CAElBC,eAAe,CAAC,CAAC7C,IAAI,CAACiC,GAAN,CAFE,CAGlBa,QAAQ,CAAC,kBAAC9C,IAAD,CAAQ,CACb,MAAI,CAACc,QAAL,CAAc,CACVd,IAAI,CAAJA,IADU,CAAd,EAGH,CAPiB,CAAtB,CAYA,MACI,4BAAM,KAAK,CAAEK,KAAb,EACI,4BACI,QAAQ,KADZ,CAEI,MAAM,CAAC,KAFX,CAGI,QAAQ,CAAEN,OAHd,CAII,UAAU,CAAED,KAJhB,CAKI,OAAO,CAAE,KAAKM,OALlB,CAMI,UAAU,CAAE,CAAC2C,eAAe,CAAC,CAAjB,CANhB,CAOI,YAAY,CAAEJ,YAPlB,CAQI,KAAK,CAAE,KAAKJ,KARhB,EADJ,CAWI,4BACI,KAAK,CAAC,0BADV,CAEI,OAAO,CAAEtC,SAFb,CAGI,IAAI,CAAE,KAAKQ,OAHf,CAII,QAAQ,CAAE,KAAK4B,YAJnB,EAMI,oBAAC,OAAD,EAAU,OAAO,CAAE,iBAAC3B,IAAD,CAAS,CAAC,MAAI,CAACA,IAAL,CAAYA,IAAZ,CAAiB,CAA9C,EANJ,CAXJ,CAoBI,4BACI,KAAK,CAAC,0BADV,CAEI,OAAO,CAAER,UAFb,CAGI,IAAI,CAAE,KAAKoB,UAHf,CAII,QAAQ,CAAE,KAAKgB,gBAJnB,EAMI,oBAAC,QAAD,EAAU,GAAG,CAAG,KAAKd,IAArB,CAA2B,IAAI,CAAExB,IAAjC,EANJ,CApBJ,CADJ,CA+BH,C,kBApL6Bd,KAAK,CAAC8D,S,SAAnBrD,I","sourcesContent":["import React from 'react'\nimport {Button, Table, Card, Modal,message} from \"antd\"\nimport {PAGE_SIZE} from \"../../utils/constant\";\nimport AddForm from \"./add-form\";\nimport AuthForm from \"./auth-form\";\nimport {reqAddUser,reqUpdateRole} from \"../../api\";\nimport memoryUtils from \"../../utils/memoryUtils\";\nimport {formateDate} from \"../../utils/dateUtils\";\nimport storageUtiles from \"../../utils/storageUtiles\";\n\nexport default class Role extends React.Component {\n    state = {\n        roles:[{\n            \"menus\":[\n                \"/home\",\n                \"/products\",\n                \"/category\",\n                \"/product\",\n                \"/role\"\n            ],\n            \"_id\":\"5ca9eac0\",\n            \"name\":\"角色1\",\n            \"create_time\":1554639552758,\n            \"_v\":0,\n            \"auth_time\":1557630307021,\n            \"auth_name\":\"admim\"\n        }],\n        loading:false,\n        role:{},\n        isShowAdd:false,\n        isShowAuth:false\n    }\n\n    constructor(props) {\n        super(props);\n        this.auth = React.createRef()\n    }\n\n    initColumn = () =>{\n        this.columns = [\n            {\n                title:'角色名称',\n                dataIndex:'name'\n            }, {\n                title:'创建时间',\n                dataIndex:'create_time',\n                render:(creat_time)=>formateDate(creat_time)\n            },{\n                title:'授权时间',\n                dataIndex:'auth_time',\n                render:formateDate\n            },{\n                title:'授权人',\n                dataIndex:'auth_name'\n            },\n        ]\n    }\n\n    addRole =() =>{\n        this.form.validateFields(async(err,values)=>{\n            if(!err){\n                this.setState({isShowAdd:false})\n                const {roleName} = values\n                this.form.resetFields()\n                const result = await reqAddUser(roleName)\n                if(result.status===0){\n                    message.success(\"添加陈宫\")\n                    const role = result.data\n                    this.setState(state=>({\n                        roles:[...state.roles,role]\n                    }))\n\n                }else{\n                    message.error(\"添加失败\")\n                }\n            }\n        })\n    }\n\n    updateRole = async() =>{\n        this.setState({\n            isShowAuth:true\n        })\n        const role = this.state.role\n        const menus = this.auth.current.getMenus\n        role.menus = menus\n        role.auth_name = memoryUtils.user.username\n        role.auth_time = Date.now()\n        const result = await reqUpdateRole(role)\n        if(result.state===0){\n            message.success(\"设置角色权限成功\")\n            if(role._id == memoryUtils.user.role._id){\n                memoryUtils.user ={}\n                storageUtiles.removeUser()\n                this.props.history.replace('/login')\n            }\n            this.setState({\n                roles:[...this.state.roles]\n            })\n        }else{\n            message.error(\"设置角色失败\")\n        }\n\n    }\n\n    handleCancel =()=>{\n        this.setState({isShowAdd:false})\n        this.form.resetFields()\n    }\n\n    handleCancelAuth =()=>{\n        this.setState({isShowAuth:false})\n\n    }\n\n    onRow = (role)=>{\n        return {\n            onClick : event=>{\n                this.setState({\n                    role\n                })\n            }\n        }\n    }\n\n\n    componentWillMount(){\n        this.initColumn()\n    }\n\n    // componentWillReceiveProps(nextProps, nextContext) {\n    //     console.log(nextProps.role);\n    //    // const menus = nextProps.role.menus\n    //    // this.state.checkedKeys = menus\n    // }\n\n\n    render(){\n        const {roles,loading,role,isShowAdd,isShowAuth} = this.state\n\n        const title=(\n            <span>\n                    <Button type=\"primary\" onClick={()=>this.setState({isShowAdd: true})}>创建角色</Button>&nbsp;&nbsp;\n                    <Button type=\"primary\" disabled={!role._id} onClick={()=>this.setState({isShowAuth: true})}>设置角色权限</Button>\n            </span>\n        )\n\n        const rowSelection = ({\n            type:'radio',\n            selectedRowKeys:[role._id],\n            onSelect:(role)=>{\n                this.setState({\n                    role\n                })\n            }\n        })\n\n\n\n        return (\n            <Card title={title} >\n                <Table\n                    bordered\n                    rowKey=\"_id\"\n                    loadding={loading}\n                    dataSource={roles}\n                    columns={this.columns}\n                    pagination={{defaultPageSize:5}}\n                    rowSelection={rowSelection}\n                    onRow={this.onRow}\n                 />\n                <Modal\n                    title=\"添加角色\"\n                    visible={isShowAdd}\n                    onOk={this.addRole}\n                    onCancel={this.handleCancel}\n                >\n                    <AddForm  setForm={(form)=> {this.form = form} } />\n                </Modal>\n\n                <Modal\n                    title=\"设置权限\"\n                    visible={isShowAuth}\n                    onOk={this.updateRole}\n                    onCancel={this.handleCancelAuth}\n                >\n                    <AuthForm ref={ this.auth} role={role} />\n                </Modal>\n            </Card>\n        )\n    }\n}"]},"metadata":{},"sourceType":"module"}